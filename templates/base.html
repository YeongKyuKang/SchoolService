<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festival Service - {% block title %}{% endblock %}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
          }
          
          header {
            background-color: black;
            color: white;
            padding: 1rem;
            margin-bottom: 20px;
          }
          
          nav {
            display: flex;
            justify-content: space-between;
            align-items: right;
          }
          
          .logo {
            font-size: 1.5rem;
            font-weight: bold;
          }
          
          nav ul {
            list-style-type: none;
            padding: 0;
            display: flex;
          }
          
          nav ul li {
            margin-left: 1rem;
          }
          
          nav ul li a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
          }
          
          nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
          }
          
          .logout-btn {
            background-color: #f44336;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          }
          
          .logout-btn:hover {
            background-color: #d32f2f;
          }
          
          .hero {
            background-image: url('/static/images/festival-back.jfif');
            background-size: cover;
            background-position: center;
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            position: relative;
          }
          
          .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
          }
          
          .hero h1, .hero p {
            position: relative;
            z-index: 1;
          }
          
          .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
          }
          
          .hero p {
            font-size: 1.5rem;
          }
          
          footer {
            background-color: black;
            color: white;
            padding: 2rem 0;
            margin-top: 20px;
          }
          
          .footer-content {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
          }
          
          .footer-section {
            margin-bottom: 1rem;
          }
          
          .footer-bottom {
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #444;
          }
          
          .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
          }
          
          .festival-list {
            width: 100%;
          }
          
          .festival-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
          }
          
          .festival-grid-item {
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
          }
          
          .festival-grid-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
          }
          
          .festival-grid-item h3 {
            margin: 10px 0;
          }
          
          .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
          }
          
          .pagination-link {
            margin: 0 5px;
            padding: 5px 10px;
            background-color: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
          }
          
          .pagination-link:hover {
            background-color: #f0f0f0;
          }
          
          .pagination-link.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
          }
          
          .pagination-link.disabled {
            color: #ccc;
            cursor: not-allowed;
          }
          
          .apply-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
          }
          
          .apply-button:hover {
            background-color: #45a049;
          }
          
          .apply-button.reserved {
            background-color: #ccc;
            cursor: not-allowed;
          }
          
          .apply-button.reserved:hover {
            background-color: #ccc;
          }
          
          .festival-application {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
          }
          
          .section-title {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2em;
            color: #333;
          }
          
          .application-container {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            gap: 2rem;
          }
          
          .festival-info {
            width: 45%;
            padding-left: 5px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            margin-top: 6rem;
          }
          
          .festival-info img {
            max-width: 100%;
            height: auto;
            margin-bottom: 1rem;
          }
          
          .festival-info h3 {
            margin-top: 0;
          }
          
          .seat-selection {
            width: 45%;
            padding-right: 5px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
          }
          
          .seat-selection h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
          }
          
          .seat-selection-content {
            margin-top: 1rem;
            max-width: 600px;
            margin: 0 auto;
          }
          
          .seat-grid-container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
            height: 500px;
            overflow-y: auto;
          }
          
          .seat-grid-container::-webkit-scrollbar {
            width: 8px;
          }
          
          .seat-grid-container::-webkit-scrollbar-track {
            background: #f1f1f1;
          }
          
          .seat-grid-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
          }
          
          .seat-grid-container::-webkit-scrollbar-thumb:hover {
            background: #555;
          }
          
          .seat-grid-container {
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
          }
          
          .seat-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
          }
          
          .seat-row {
            display: flex;
            justify-content: center;
            gap: 10px;
          }
          
          .seat {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.8em;
          }
          
          .seat:hover {
            background-color: #e0e0e0;
          }
          
          .seat.occupied {
            background-color: #ff0000;
            cursor: not-allowed;
          }
          
          .seat.selected {
            background-color: #00ff00;
          }
          
          .spacer {
            width: 40px;
            height: 40px;
          }
          
          .button-container {
            margin-top: 2rem;
            width: 100%;
          }
          
          #applyButton {
            width: 100%;
            padding: 15px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1.1em;
            letter-spacing: 3px;
            text-align: center;
            text-transform: uppercase;
          }
          
          #applyButton:disabled {
            background-color: #9e9e9e;
            cursor: not-allowed;
          }
          
          #applyButton:hover:not(:disabled) {
            background-color: #45a049;
          }
          
          .return-button-container {
            text-align: center;
            margin-top: 2rem;
          }
          
          .return-button {
            display: inline-block;
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
            background-color: black;
          }
          
          .return-button:hover {
            background-color: #2980b9;
          }
          
          .seat-info {
            text-align: left;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #4CAF50;
          }
          
          .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            width: 100%;
          }
          
          .spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
          }
          
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .loading-indicator p {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
          }
          
          .pagination-ellipsis {
            margin: 0 5px;
            color: #333;
          }
          
          @media (max-width: 768px) {
            .application-container {
              flex-direction: column;
            }
          
            .festival-info,
            .seat-selection {
              width: 100%;
              padding-left: 0;
              padding-right: 0;
            }
            .seat-grid {
              max-height: 400px;
            }
          }
          
          
    </style>
</head>
<body>
    {% include 'components/navbar.html' %}
    
    {% block hero %}{% endblock %}
    
    <main>
        {% block content %}{% endblock %}
    </main>

    {% include 'components/footer.html' %}
    <script>
        let allFestivals, allCancelFestivals;

document.addEventListener('DOMContentLoaded', function() {

    const festivalServiceImages = [
        'autumn-festival.jfif',
        'canoe-festival.jfif',
        'culture-festival.jfif',
        'festival-schedule.jfif',
        'music-festival.jfif',
        'sports-festival.jfif',
        'spring-festival.jfif',
        'summer-festival.jfif',
        'winter-festival.jfif',
        'default.jpg'
    ];

    allFestivals = typeof festivalsData !== 'undefined' ? festivalsData : [];
    allCancelFestivals = typeof userReservedFestivals !== 'undefined' ? userReservedFestivals : [];

    const festivalsPerPage = 3;
    let currentPage = 1;
    let currentCancelPage = 1;
    
    console.log("Total festivals in JavaScript:", allFestivals.length);
    console.log("Total cancel festivals in JavaScript:", allCancelFestivals.length);

    function showLoading(id) {
        const loadingElement = document.getElementById(id);
        const listElement = document.getElementById(id.replace('-loading-indicator', '-list'));
        if (loadingElement) loadingElement.style.display = 'flex';
        if (listElement) listElement.style.display = 'none';
    }

    function hideLoading(id) {
        const loadingElement = document.getElementById(id);
        const listElement = document.getElementById(id.replace('-loading-indicator', '-list'));
        if (loadingElement) loadingElement.style.display = 'none';
        if (listElement) listElement.style.display = 'grid';
    }

    function displayFestivals() {
        showLoading('festival-loading-indicator');
        const startIndex = (currentPage - 1) * festivalsPerPage;
        const endIndex = startIndex + festivalsPerPage;
        const festivalsToShow = allFestivals.slice(startIndex, endIndex);

        console.log("Displaying festivals:", startIndex, "to", endIndex);

        const festivalGrid = document.getElementById('festival-list');
        if (!festivalGrid) {
            console.error("Festival list element not found");
            return;
        }
        festivalGrid.innerHTML = '';

        festivalsToShow.forEach((festival, index) => {
            const festivalElement = document.createElement('div');
            festivalElement.className = 'festival-grid-item';
            const isReserved = festival.is_reserved;
            const isFull = festival.is_full;
            const imageIndex = (startIndex + index) % festivalServiceImages.length;
            const imageSrc = `/static/images/${festivalServiceImages[imageIndex]}`;
            festivalElement.innerHTML = `
                 <img src="${imageSrc}" alt="${festival.title}" onerror="this.src='/static/images/default.jpg';">
                <h3>${festival.title}</h3>
                <p>날짜: ${new Date(festival.date).toLocaleDateString()}</p>
                <p>좌석현황: ${festival.capacity}/${festival.total_seats}</p>  
                ${isReserved 
                    ? `<button class="apply-button reserved" disabled>이미 예약한 축제입니다</button>`
                    : isFull
                        ? `<button class="apply-button full" disabled>신청 마감</button>`
                        : `<a href="/festival/apply/${festival.festival_key}?image=${encodeURIComponent(festivalServiceImages[imageIndex])}" class="apply-button">지금 신청하기</a>`
                }
            `;
            festivalGrid.appendChild(festivalElement);
        });

        setupPagination('festival-pagination', allFestivals.length, currentPage, changePage);
        hideLoading('festival-loading-indicator');
    }

    function displayCancelFestivals() {
        showLoading('cancel-loading-indicator');
        const startIndex = (currentCancelPage - 1) * festivalsPerPage;
        const endIndex = startIndex + festivalsPerPage;
        const festivalsToShow = allCancelFestivals.slice(startIndex, endIndex);

        console.log("Displaying cancel festivals:", startIndex, "to", endIndex);

        const festivalGrid = document.getElementById('cancel-festival-list');
        if (!festivalGrid) {
            console.error("Cancel festival list element not found");
            return;
        }
        festivalGrid.innerHTML = '';

        festivalsToShow.forEach(festival => {
            const festivalElement = document.createElement('div');
            festivalElement.className = 'festival-grid-item';
            festivalElement.innerHTML = `
                <h3>${festival.title}</h3>
                <p>좌석 번호: ${festival.seat_number}</p>
                <p>예약 시간: ${new Date(festival.reservation_time).toLocaleString()}</p>
                <p>상태: 예약됨</p>
                <button class="cancel-button" data-reservation-id="${festival.id}">예약 취소</button>
            `;
            festivalGrid.appendChild(festivalElement);
        });

        setupPagination('cancel-pagination', allCancelFestivals.length, currentCancelPage, changeCancelPage);
        hideLoading('cancel-loading-indicator');
    }

    function setupPagination(paginationId, totalItems, currentPageNum, changePageFunc) {
        const totalPages = Math.ceil(totalItems / festivalsPerPage);
        console.log(`Total ${paginationId} pages:`, totalPages);

        const pagination = document.getElementById(paginationId);
        if (!pagination) {
            console.error(`Pagination element with id ${paginationId} not found`);
            return;
        }
        pagination.innerHTML = '';

        if (currentPageNum > 1) {
            pagination.innerHTML += `<a href="#" class="pagination-link" data-page="${currentPageNum - 1}">&lt;</a>`;
        }

        const maxVisiblePages = 6;
        let startPage = Math.max(1, currentPageNum - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
            pagination.innerHTML += `<a href="#" class="pagination-link" data-page="1">1</a>`;
            if (startPage > 2) {
                pagination.innerHTML += `<span class="pagination-ellipsis">...</span>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            pagination.innerHTML += `<a href="#" class="pagination-link ${i === currentPageNum ? 'active' : ''}" data-page="${i}">${i}</a>`;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                pagination.innerHTML += `<span class="pagination-ellipsis">...</span>`;
            }
            pagination.innerHTML += `<a href="#" class="pagination-link" data-page="${totalPages}">${totalPages}</a>`;
        }

        if (currentPageNum < totalPages) {
            pagination.innerHTML += `<a href="#" class="pagination-link" data-page="${currentPageNum + 1}">&gt;</a>`;
        }

        // 페이지네이션 링크에 이벤트 리스너 추가
        pagination.addEventListener('click', function(e) {
            e.preventDefault();
            if (e.target.classList.contains('pagination-link')) {
                const page = parseInt(e.target.getAttribute('data-page'));
                changePageFunc(page);
            }
        });
    }

    function changePage(page) {
        currentPage = page;
        console.log("Changing to page:", page);
        showLoading('festival-loading-indicator');
        setTimeout(() => {
            displayFestivals();
        }, 300);
    }

    function changeCancelPage(page) {
        currentCancelPage = page;
        console.log("Changing cancel page to:", page);
        showLoading('cancel-loading-indicator');
        setTimeout(() => {
            displayCancelFestivals();
        }, 300);
    }

    function refreshFestivals() {
        showLoading('festival-loading-indicator');
        showLoading('cancel-loading-indicator');
        
        fetch('/festival/festivals', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                allFestivals = data.festivals;
                allCancelFestivals = data.user_reserved_festivals || [];
                displayFestivals();
                displayCancelFestivals();
            } else {
                throw new Error(data.message || '축제 목록을 새로고침하는데 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error refreshing festivals:', error);
            alert('축제 목록을 새로고침하는데 실패했습니다: ' + error.message);
        })
        .finally(() => {
            hideLoading('festival-loading-indicator');
            hideLoading('cancel-loading-indicator');
        });
    }

    displayFestivals();
    displayCancelFestivals();

    // 예약 취소 기능 추가
    const cancelFestivalList = document.getElementById('cancel-festival-list');
    if (cancelFestivalList) {
        cancelFestivalList.addEventListener('click', function(e) {
            if (e.target.classList.contains('cancel-button')) {
                const reservationId = e.target.getAttribute('data-reservation-id');
                if (confirm('정말로 이 축제 예약을 취소하시겠습니까?')) {
                    cancelReservation(reservationId);
                }
            }
        });
    }

    function cancelReservation(reservationId) {
        fetch(`/festival/cancel_reservation/${reservationId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('예약이 성공적으로 취소되었습니다.');
                refreshFestivals();
                window.location.reload();
            } else {
                throw new Error(data.message || '예약 취소에 실패했습니다.');
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.message === 'Reservation is already cancelled') {
                alert('이 예약은 이미 취소되었습니다. 페이지를 새로고침합니다.');
                refreshFestivals();
                window.location.reload();
            } else {
                alert('예약 취소 중 오류가 발생했습니다: ' + error.message);
                window.location.reload();
            }
        });
    }
});
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch(window.location.href)
                .then(response => {
                    if (response.status === 401) {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        alert(data.error);
                        window.location.href = data.redirect;
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>